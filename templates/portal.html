<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Portal Administrativo</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet"/>
<style> 
    body { font-family: 'Inter', sans-serif; } 
    .nav-item.active { @apply bg-blue-50 text-blue-700 border-r-4 border-blue-600; }
    .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .input-field { @apply w-full p-3 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition; }
    .btn-primary { @apply py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-500/20; }
    .btn-secondary { @apply py-3 bg-white border border-gray-200 text-gray-600 font-bold rounded-xl hover:bg-gray-50 transition; }
    .label { @apply block text-xs font-bold text-gray-400 uppercase mb-1 ml-1; }
</style>
</head>
<body class="bg-gray-50 h-screen flex overflow-hidden">

    {% if usuario.tipo_acesso == 'admin' %}

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-gray-200 hidden md:flex flex-col z-20 shrink-0">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <span class="material-symbols-rounded text-blue-600 text-3xl mr-2">engineering</span>
            <div><h1 class="font-bold text-gray-800 leading-none">Sky ALP</h1><p class="text-[10px] text-gray-400 uppercase tracking-widest font-bold">Admin Portal</p></div>
        </div>
        <nav class="flex-1 py-6 space-y-1 overflow-y-auto">
            <button onclick="mudarAba('leads')" id="btn-leads" class="nav-item w-full flex items-center px-6 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition group active">
                <span class="material-symbols-rounded mr-3 group-hover:text-blue-500">inbox_customize</span><span class="font-medium text-sm">Solicitações</span>
                {% if mensagens %}<span class="ml-auto bg-orange-100 text-orange-600 py-0.5 px-2 rounded-full text-xs font-bold">{{ mensagens|length }}</span>{% endif %}
            </button>
            <button onclick="mudarAba('gestao')" id="btn-gestao" class="nav-item w-full flex items-center px-6 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition group">
                <span class="material-symbols-rounded mr-3 group-hover:text-blue-500">domain</span><span class="font-medium text-sm">Gestão & Obras</span>
            </button>
            <button onclick="mudarAba('equipe')" id="btn-equipe" class="nav-item w-full flex items-center px-6 py-3 text-gray-500 hover:bg-gray-50 hover:text-gray-900 transition group">
                <span class="material-symbols-rounded mr-3 group-hover:text-blue-500">groups</span><span class="font-medium text-sm">Equipe Global</span>
            </button>
        </nav>
        <div class="p-4 border-t border-gray-100"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-700 font-bold text-xs">{{ usuario.nome[0] }}</div><div class="flex-1 min-w-0"><p class="text-sm font-medium text-gray-900 truncate">{{ usuario.nome.split(' ')[0] }}</p><p class="text-xs text-gray-500 truncate">Administrador</p></div><a href="/logout" class="text-gray-400 hover:text-red-500 transition"><span class="material-symbols-rounded">logout</span></a></div></div>
    </aside>

    <div class="md:hidden fixed top-0 w-full bg-white border-b border-gray-200 z-30 px-4 py-3 flex justify-between items-center"><span class="font-bold text-gray-800 flex items-center gap-2"><span class="material-symbols-rounded text-blue-600">engineering</span> Sky ALP</span><button onclick="document.getElementById('mobileMenu').classList.toggle('hidden')" class="text-gray-600"><span class="material-symbols-rounded">menu</span></button></div>
    <div id="mobileMenu" class="hidden fixed inset-0 bg-gray-800/50 z-40 md:hidden flex flex-col" onclick="this.classList.add('hidden')"><div class="w-64 bg-white h-full shadow-xl ml-auto flex flex-col p-4" onclick="event.stopPropagation()"><button onclick="mudarAba('leads'); document.getElementById('mobileMenu').classList.add('hidden')" class="p-3 text-left font-bold text-gray-700 border-b">Solicitações</button><button onclick="mudarAba('gestao'); document.getElementById('mobileMenu').classList.add('hidden')" class="p-3 text-left font-bold text-gray-700 border-b">Gestão</button><button onclick="mudarAba('equipe'); document.getElementById('mobileMenu').classList.add('hidden')" class="p-3 text-left font-bold text-gray-700 border-b">Equipe</button><a href="/logout" class="p-3 text-left text-red-500 mt-auto">Sair</a></div></div>

    <main class="flex-1 overflow-y-auto pt-16 md:pt-0 p-6 md:p-10 relative">
        
        <!-- LEADS -->
        <div id="aba-leads" class="tab-content active max-w-5xl mx-auto">
            <header class="mb-8"><h2 class="text-2xl font-bold text-gray-900">Solicitações de Orçamento</h2><p class="text-gray-500 text-sm">Leads da Landing Page.</p></header>
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                {% if mensagens %}
                <div class="overflow-x-auto"><table class="w-full text-left text-sm whitespace-nowrap md:whitespace-normal"><thead class="bg-gray-50 border-b border-gray-200 text-gray-500 uppercase text-xs font-bold"><tr><th class="px-6 py-4">Data</th><th class="px-6 py-4">Cliente</th><th class="px-6 py-4">Contato</th><th class="px-6 py-4">Mensagem</th><th class="px-6 py-4">Ação</th></tr></thead><tbody class="divide-y divide-gray-100">{% for msg in mensagens %}<tr class="hover:bg-blue-50/30 transition group"><td class="px-6 py-4 text-gray-400 text-xs">{{ msg.data_envio }}</td><td class="px-6 py-4 font-bold text-gray-800">{{ msg.nome }}</td><td class="px-6 py-4"><div class="text-gray-600">{{ msg.email }}</div><div class="text-xs text-gray-400">{{ msg.telefone }}</div></td><td class="px-6 py-4 max-w-xs truncate text-gray-600" title="{{ msg.mensagem }}"><span class="bg-gray-100 text-gray-500 px-2 py-0.5 rounded text-[10px] uppercase font-bold mr-2">{{ msg.assunto }}</span>{{ msg.mensagem }}</td><td class="px-6 py-4"><a href="mailto:{{ msg.email }}" class="text-blue-600 hover:text-blue-800 font-bold text-xs flex items-center gap-1">Responder <span class="material-symbols-rounded text-sm">reply</span></a></td></tr>{% endfor %}</tbody></table></div>
                {% else %}
                <div class="flex flex-col items-center justify-center py-20 text-center text-gray-400"><span class="material-symbols-rounded text-4xl mb-2">inbox</span><p>Caixa vazia.</p></div>
                {% endif %}
            </div>
        </div>

        <!-- GESTÃO (CLIENTES E OBRAS) -->
        <div id="aba-gestao" class="tab-content max-w-6xl mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <div><h2 class="text-2xl font-bold text-gray-900">Painel de Obras</h2><p class="text-gray-500 text-sm">Gerencie projetos ativos.</p></div>
                <button onclick="abrirModalCliente()" class="bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-50 flex items-center gap-2"><span class="material-symbols-rounded text-lg">person_add</span> Cliente</button>
            </header>

            <div class="space-y-8">
                {% if not clientes %}
                <div class="text-center py-12 border-2 border-dashed border-gray-200 rounded-xl"><p class="text-gray-400">Adicione um cliente para começar.</p></div>
                {% endif %}

                {% for cli in clientes %}
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="px-6 py-4 border-b border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-gray-50/50">
                        <div class="flex items-center gap-2">
                            <span class="material-symbols-rounded text-gray-400">business</span>
                            <h3 class="font-bold text-gray-800 text-lg">{{ cli.nome }}</h3>
                            <button onclick="abrirModalCliente('{{ cli.id }}', '{{ cli.nome }}', '{{ cli.cnpj }}', '{{ cli.cidade }}')" class="text-gray-400 hover:text-blue-600 p-1 rounded transition"><span class="material-symbols-rounded text-sm">edit</span></button>
                        </div>
                        <button onclick="abrirModalObra(null, '{{ cli.id }}', '{{ cli.nome }}')" class="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-1 bg-blue-50 px-3 py-1.5 rounded-lg transition"><span class="material-symbols-rounded text-sm">add</span> Nova Obra</button>
                    </div>
                    <div class="divide-y divide-gray-100">
                        {% for obra in cli.obras %}
                        <div class="p-5 flex flex-col sm:flex-row sm:items-center justify-between gap-4 hover:bg-blue-50/20 transition group">
                            <div class="flex items-center gap-4 flex-1">
                                <div class="w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold text-xl shadow-sm" style="background-color: {{ obra.cor_primaria }}">{{ obra.nome[0] }}</div>
                                <div>
                                    <div class="flex items-center gap-2">
                                        <h4 class="font-bold text-gray-900 group-hover:text-blue-700 transition">{{ obra.nome }}</h4>
                                        <button onclick="abrirModalObra('{{ obra.id }}', '{{ cli.id }}', '{{ cli.nome }}', '{{ obra.nome }}', '{{ obra.localizacao }}')" class="text-gray-300 hover:text-blue-500 transition"><span class="material-symbols-rounded text-xs">edit</span></button>
                                    </div>
                                    <div class="flex items-center gap-3 text-xs text-gray-500 mt-1"><span class="flex items-center gap-1"><span class="material-symbols-rounded text-sm">location_on</span> {{ obra.localizacao }}</span><span class="w-1 h-1 bg-gray-300 rounded-full"></span><span class="flex items-center gap-1 text-orange-500">{{ obra.status }}</span></div>
                                </div>
                            </div>
                            <a href="/gerenciar_obra/{{ obra.id }}" class="flex items-center justify-center gap-2 px-5 py-2.5 bg-white border border-gray-200 text-gray-700 font-bold text-sm rounded-lg hover:border-blue-500 hover:text-blue-600 hover:shadow-md transition">Acessar <span class="material-symbols-rounded text-lg">arrow_forward</span></a>
                        </div>
                        {% else %}
                        <div class="p-6 text-center text-gray-400 text-sm italic">Nenhuma obra cadastrada.</div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- EQUIPE GLOBAL -->
        <div id="aba-equipe" class="tab-content max-w-6xl mx-auto">
            <header class="mb-8 flex justify-between items-center">
                <div><h2 class="text-2xl font-bold text-gray-900">Equipe Global</h2><p class="text-gray-500 text-sm">Cadastro de colaboradores.</p></div>
                <button onclick="abrirModalFunc()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-lg shadow-blue-500/20 flex items-center gap-2"><span class="material-symbols-rounded">person_add</span> Novo</button>
            </header>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto"><table class="w-full text-sm text-left whitespace-nowrap md:whitespace-normal"><thead class="bg-gray-50 border-b border-gray-200 text-gray-500 uppercase font-bold text-xs"><tr><th class="px-6 py-4">Nome</th><th class="px-6 py-4">Função</th><th class="px-6 py-4">Acesso</th><th class="px-6 py-4">Credenciais</th><th class="px-6 py-4 text-right">Ações</th></tr></thead><tbody class="divide-y divide-gray-100">
                    {% for f in funcionarios %}
                    <tr class="hover:bg-blue-50/20 transition">
                        <td class="px-6 py-4 font-bold text-gray-800">{{ f.nome }}</td>
                        <td class="px-6 py-4 text-gray-600">{{ f.funcao }}</td>
                        <td class="px-6 py-4"><span class="inline-flex items-center px-2 py-1 rounded text-xs font-bold uppercase tracking-wider {{ 'bg-purple-100 text-purple-700 border border-purple-200' if f.tipo_acesso == 'admin' else 'bg-green-100 text-green-700 border border-green-200' }}">{{ 'Gestor' if f.tipo_acesso == 'admin' else 'Operário' }}</span></td>
                        <td class="px-6 py-4"><div class="flex flex-col text-xs"><span class="text-blue-600 font-bold">U: {{ f.login }}</span><span class="text-gray-400">P: {{ f.senha }}</span></div></td>
                        <td class="px-6 py-4 text-right flex justify-end gap-2">
                            <button onclick="abrirModalFunc('{{ f.id }}', '{{ f.nome }}', '{{ f.funcao }}', '{{ f.cpf }}', '{{ f.telefone }}', '{{ f.login }}', '{{ f.tipo_acesso }}')" class="text-blue-400 hover:text-blue-600 p-1"><span class="material-symbols-rounded">edit</span></button>
                            <button onclick="excluirFunc('{{ f.id }}')" class="text-red-400 hover:text-red-600 p-1"><span class="material-symbols-rounded">delete</span></button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody></table></div>
            </div>
        </div>
    </main>

    {% else %}
    <div class="w-full h-full flex items-center justify-center bg-gray-50 p-4"><div class="bg-white p-8 rounded-2xl shadow-xl max-w-md text-center"><span class="material-symbols-rounded text-5xl text-gray-300 mb-4">lock</span><h2 class="text-xl font-bold text-gray-900">Acesso Restrito</h2><a href="/logout" class="block w-full bg-gray-900 text-white font-bold py-3 rounded-xl mt-4">Sair</a></div></div>
    {% endif %}

    <!-- MODAL CLIENTE -->
    <div id="modalCliente" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 id="modalCliTitle" class="text-lg font-bold mb-4 text-gray-900">Cliente</h3>
            <input type="hidden" id="cliId">
            <div class="space-y-3"><input id="cliNome" placeholder="Nome da Empresa" class="input-field"><input id="cliCidade" placeholder="Cidade" class="input-field"><input id="cliCNPJ" placeholder="NIF/CNPJ" class="input-field"></div>
            <div class="flex gap-3 mt-6"><button onclick="this.closest('.fixed').classList.add('hidden')" class="flex-1 btn-secondary">Cancelar</button><button onclick="salvarCliente()" class="flex-1 btn-primary">Salvar</button></div>
        </div>
    </div>

    <!-- MODAL OBRA -->
    <div id="modalObra" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm transition-opacity">
        <div class="bg-white rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <h3 id="modalObraTitle" class="text-lg font-bold mb-1 text-gray-900">Obra</h3>
            <p id="obraCliNome" class="text-xs text-gray-500 font-bold uppercase mb-6"></p>
            <input type="hidden" id="obraId"><input type="hidden" id="obraCliId">
            <div class="space-y-4"><div><label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Dados da Obra</label><input id="obraNome" placeholder="Nome do Empreendimento" class="input-field mb-2"><input id="obraLocal" placeholder="Localização" class="input-field"></div></div>
            <div class="flex gap-3 mt-8"><button onclick="this.closest('.fixed').classList.add('hidden')" class="flex-1 btn-secondary">Cancelar</button><button onclick="salvarObra()" class="flex-1 btn-primary">Salvar</button></div>
        </div>
    </div>

    <!-- MODAL FUNCIONÁRIO -->
    <div id="modalFunc" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50 px-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl p-6 w-full max-w-lg shadow-2xl">
            <h3 id="modalFuncTitle" class="text-lg font-bold mb-4 text-gray-900 border-b pb-2">Colaborador</h3>
            <input type="hidden" id="funcId">
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">Nome</label><input id="fNome" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Função</label><input id="fFuncao" placeholder="Ex: Pedreiro" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm"></div></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-bold text-gray-500 uppercase">CPF</label><input id="fCpf" placeholder="000.000.000-00" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm"></div><div><label class="block text-xs font-bold text-gray-500 uppercase">Telefone</label><input id="fTel" placeholder="(00) 00000-0000" class="w-full p-2.5 bg-gray-50 border rounded-lg text-sm"></div></div>
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <p class="text-xs font-bold text-blue-800 uppercase mb-2">Acesso ao Sistema</p>
                    <div class="grid grid-cols-2 gap-4 mb-3"><div><label class="text-xs font-bold text-blue-400">Usuário</label><input id="fLogin" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-sm"></div><div><label class="text-xs font-bold text-blue-400">Senha</label><input id="fSenha" placeholder="****" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-sm"></div></div>
                    <div><label class="text-xs font-bold text-blue-400">Cargo</label><select id="fTipo" class="w-full p-2 bg-white border border-blue-200 rounded-lg text-sm font-bold text-slate-700 mt-1"><option value="operador">Operário (App Mobile)</option><option value="admin">Gestor (Web)</option></select></div>
                </div>
            </div>
            <div class="flex gap-3 mt-6"><button onclick="this.closest('.fixed').classList.add('hidden')" class="flex-1 btn-secondary">Cancelar</button><button onclick="salvarFunc()" class="flex-1 btn-primary">Salvar</button></div>
        </div>
    </div>
    
    <script>
        function mudarAba(aba) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('aba-' + aba).classList.add('active');
            document.getElementById('btn-' + aba).classList.add('active');
        }

        // --- LÓGICA DE CLIENTE ---
        function abrirModalCliente(id='', nome='', cnpj='', cidade='') {
            document.getElementById('cliId').value = id;
            document.getElementById('cliNome').value = nome;
            document.getElementById('cliCNPJ').value = cnpj;
            document.getElementById('cliCidade').value = cidade;
            document.getElementById('modalCliTitle').innerText = id ? "Editar Cliente" : "Novo Cliente";
            document.getElementById('modalCliente').classList.remove('hidden');
        }
        async function salvarCliente() {
            const id = document.getElementById('cliId').value;
            const dados = { id, nome: document.getElementById('cliNome').value, cidade: document.getElementById('cliCidade').value, cnpj: document.getElementById('cliCNPJ').value };
            if(!dados.nome) return alert('Nome obrigatório');
            const url = id ? '/api/editar_cliente' : '/api/criar_cliente';
            await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            window.location.reload();
        }

        // --- LÓGICA DE OBRA ---
        function abrirModalObra(id, cliId, cliNome, nome='', local='') {
            document.getElementById('obraId').value = id || '';
            document.getElementById('obraCliId').value = cliId;
            document.getElementById('obraCliNome').innerText = "Cliente: " + cliNome;
            document.getElementById('obraNome').value = nome;
            document.getElementById('obraLocal').value = local;
            document.getElementById('modalObraTitle').innerText = id ? "Editar Obra" : "Nova Obra";
            document.getElementById('modalObra').classList.remove('hidden');
        }
        async function salvarObra() {
            const id = document.getElementById('obraId').value;
            const dados = { id, cliente_id: document.getElementById('obraCliId').value, nome: document.getElementById('obraNome').value, local: document.getElementById('obraLocal').value };
            if(!dados.nome) return alert('Nome obrigatório');
            const url = id ? '/api/editar_obra' : '/api/criar_obra';
            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            const data = await res.json();
            if (id) window.location.reload(); else window.location.href = '/gerenciar_obra/' + data.id;
        }

        // --- LÓGICA DE FUNCIONÁRIO ---
        function abrirModalFunc(id='', nome='', funcao='', cpf='', tel='', login='', tipo='operador') {
            document.getElementById('funcId').value = id;
            document.getElementById('fNome').value = nome;
            document.getElementById('fFuncao').value = funcao;
            document.getElementById('fCpf').value = cpf == 'None' ? '' : cpf;
            document.getElementById('fTel').value = tel == 'None' ? '' : tel;
            document.getElementById('fLogin').value = login;
            document.getElementById('fSenha').value = ''; 
            document.getElementById('fTipo').value = tipo;
            document.getElementById('modalFuncTitle').innerText = id ? "Editar Colaborador" : "Novo Colaborador";
            document.getElementById('modalFunc').classList.remove('hidden');
        }
        async function salvarFunc() {
            const id = document.getElementById('funcId').value;
            const dados = { 
                id, nome: document.getElementById('fNome').value, funcao: document.getElementById('fFuncao').value, 
                cpf: document.getElementById('fCpf').value, telefone: document.getElementById('fTel').value, 
                login: document.getElementById('fLogin').value, senha: document.getElementById('fSenha').value, tipo: document.getElementById('fTipo').value 
            };
            if(!dados.login) return alert("Login obrigatório");
            const url = id ? '/api/editar_funcionario' : '/api/criar_funcionario_global';
            const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(dados) });
            if(res.ok) window.location.reload(); else alert("Erro: Login pode já existir.");
        }
        async function excluirFunc(id) { if(confirm("Excluir este funcionário do sistema?")) { await fetch('/api/excluir_func', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({id}) }); window.location.reload(); } }
    </script>
</body>
</html>